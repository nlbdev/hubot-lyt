#!/bin/bash

#set -e

npm install
export PATH="node_modules/.bin:node_modules/hubot/node_modules/.bin:$PATH"
export HUBOT_WHITELIST="webspiller"
export HUBOT_SLACK_TOKEN="`cat ~/config/hubot-slack.token | head -n 1`"
export BOT_NAME="NLB"
ANNOUNCE_CHANNEL="#webspiller"
SLACK_WEBHOOK="`cat $HOME/config/slack.webhook | head -n 1`"
BOT_ICON="https://s3-us-west-2.amazonaws.com/slack-files2/avatars/2015-08-10/8878694496_9e4e1c78db905c4d3396_48.jpg"

if [[ "$SLACK_WEBHOOK" != "" ]] ; then
  JSON="{\"channel\": \"$ANNOUNCE_CHANNEL\", \"username\": \"$BOT_NAME\", \"icon_url\": \"$BOT_ICON\", \"text\": \"Jeg er våken!\"}"
  curl -s -d "payload=$JSON" "$SLACK_WEBHOOK"
fi
#set +e
exec node_modules/.bin/hubot --name "$BOT_NAME" --adapter slack "$@"
if [[ "$SLACK_WEBHOOK" != "" ]] ; then
  JSON="{\"channel\": \"$ANNOUNCE_CHANNEL\", \"username\": \"$BOT_NAME\", \"icon_url\": \"$BOT_ICON\", \"text\": \"Jeg går og legger meg...\"}"
  curl -s -d "payload=$JSON" "$SLACK_WEBHOOK"
fi

